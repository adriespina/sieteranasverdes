---
import ToggleMenu from "~/components/common/ToggleMenu.astro";
import Button from "~/components/ui/Button.astro";

// Removed unused imports (brand/link mapping now inline)
import type { CallToAction } from "~/types";

export interface Props {
  id?: string;
  actions?: Array<CallToAction>;
  isSticky?: boolean;
  isDark?: boolean;
  isFullWidth?: boolean;
  // Theme toggle and RSS removed
  position?: string;
}

const {
  id = "header",
  actions = [],
  isSticky = false,
  isDark = false,
  isFullWidth = false,
  position = "center",
} = Astro.props;
---

<header
  class:list={[
    { sticky: isSticky, relative: !isSticky, dark: isDark },
    "top-0 z-40 mx-auto w-full flex-none border-b border-gray-50/0 transition-[opacity] ease-in-out",
  ]}
  {...isSticky ? { "data-aw-sticky-header": true } : {}}
  {...id ? { id } : {}}
>
  <div class="absolute inset-0"></div>
  <div
    class:list={[
      "relative mx-auto w-full px-3 py-3 text-default md:px-6 md:py-4",
      {
        "md:flex md:justify-between": position !== "center",
      },
      {
        "md:grid md:grid-cols-3 md:items-center": position === "center",
      },
      {
        "max-w-7xl": !isFullWidth,
      },
    ]}
  >
    <div
      class:list={[
        { "mr-auto rtl:ml-auto rtl:mr-0": position === "right" },
        "flex justify-between",
      ]}
    >
      <a href="/" class="inline-flex items-center gap-3 no-underline">
        <img
          src="/logo.svg?v=5"
          alt="Siete Ranas Verdes"
          class="h-16 w-16 object-contain md:h-20 md:w-20"
        />
      </a>
      <div class="flex items-center md:hidden">
        <ToggleMenu />
      </div>
    </div>
    <nav
      class="hidden items-center overflow-visible md:mx-5 md:flex md:w-auto md:justify-self-center"
      aria-label="Main navigation"
    >
      <ul class="hidden items-center gap-5 whitespace-nowrap md:flex">
        <!-- Menú: Actividades -->
        <li class="relative">
          <details class="group">
            <summary
              tabindex="0"
              class="nav-dd inline-flex cursor-pointer select-none items-center gap-1 whitespace-nowrap text-base text-gray-700 hover:text-brand-800 md:text-lg"
            >
              Actividades
              <span class="ml-0.5 inline-block transition-transform group-open:rotate-180">▾</span>
            </summary>
            <div
              class="dropdown-panel absolute left-0 z-50 mt-2 w-56 rounded-xl border bg-white p-2 shadow-lg ring-1 ring-black/5"
            >
              <a
                href="/#yoga"
                class="block rounded-lg px-3 py-2 text-[15px] hover:bg-brand-50 md:text-base"
                >Yoga</a
              >
              <a
                href="/#banos"
                class="block rounded-lg px-3 py-2 text-[15px] hover:bg-brand-50 md:text-base"
                >Baños de Bosque</a
              >
              <a
                href="/#pilates"
                class="block rounded-lg px-3 py-2 text-[15px] hover:bg-brand-50 md:text-base"
                >Pilates</a
              >
              <a
                href="/#otras"
                class="block rounded-lg px-3 py-2 text-[15px] hover:bg-brand-50 md:text-base"
                >Otras actividades</a
              >
            </div>
          </details>
        </li>

        <!-- Menú: Nuestra sala -->
        <li class="relative">
          <details class="group">
            <summary
              tabindex="0"
              class="nav-dd inline-flex cursor-pointer select-none items-center gap-1 whitespace-nowrap text-base text-gray-700 hover:text-brand-800 md:text-lg"
            >
              Nuestra sala
              <span class="ml-0.5 inline-block transition-transform group-open:rotate-180">▾</span>
            </summary>
            <div
              class="dropdown-panel absolute left-0 z-50 mt-2 w-56 rounded-xl border bg-white p-2 shadow-lg ring-1 ring-black/5"
            >
              <a
                href="/#sala"
                class="block rounded-lg px-3 py-2 text-[15px] hover:bg-brand-50 md:text-base"
                >Nuestra sala</a
              >
              <a
                href="/#horario"
                class="block rounded-lg px-3 py-2 text-[15px] hover:bg-brand-50 md:text-base"
                >Horario</a
              >
            </div>
          </details>
        </li>

        <!-- Enlaces restantes -->
        <li>
          <a
            href="/#contacto"
            class="text-base text-gray-700 no-underline hover:text-brand-800 md:text-lg">Contacto</a
          >
        </li>
        <li>
          <a
            href="/blog"
            class="text-base text-gray-700 no-underline hover:text-brand-800 md:text-lg">Blog</a
          >
        </li>

        <!-- CTA (duplicado aquí para mantener estructura; el real sigue a la derecha) -->
        <li class="md:hidden"><a href="/socios" class="btn no-underline">Socios</a></li>
      </ul>
    </nav>
    <div
      class:list={[
        { "ml-auto rtl:ml-0 rtl:mr-auto": position === "left" },
        "fixed bottom-0 left-0 hidden w-full items-center justify-end p-3 md:static md:mb-0 md:flex md:w-auto md:self-center md:justify-self-end md:p-0 rtl:left-auto rtl:right-0",
      ]}
    >
      <div class="flex w-full items-center justify-between md:w-auto">
        <div class="flex"><!-- Theme toggle and RSS removed --></div>
        {
          actions?.length ? (
            <span class="ml-4 rtl:ml-0 rtl:mr-4">
              {actions.map((btnProps) => (
                <Button
                  {...btnProps}
                  class="px-5.5 btn ml-2 w-auto py-2.5 text-sm font-semibold no-underline shadow-none md:px-6"
                />
              ))}
            </span>
          ) : (
            ""
          )
        }
      </div>
    </div>
  </div>
</header>
<!-- Script: dropdowns exclusivos y cierre al hacer click fuera / seleccionar / ESC -->
<script is:inline>
  const header = document.currentScript?.closest("header") || document;
  const nav = header.querySelector("nav") || header;

  const allDetails = () => Array.from(nav.querySelectorAll("details"));
  const closeAll = (except = null) => {
    allDetails().forEach((d) => {
      if (d !== except) d.removeAttribute("open");
    });
  };

  // Asegura exclusividad: al abrir uno, cierra los demás
  allDetails().forEach((d) => {
    d.addEventListener("toggle", () => {
      if (d.hasAttribute("open")) closeAll(d);
    });
  });

  document.addEventListener("click", (e) => {
    const t = e.target;
    const current = t?.closest?.("details");
    const clickedSummary = !!t?.closest?.("summary");
    const insidePanel = !!t?.closest?.(".dropdown-panel");
    const clickedPanelLink = !!t?.closest?.(".dropdown-panel a");

    if (clickedPanelLink) {
      closeAll();
      return;
    }
    if (clickedSummary) {
      closeAll(current);
      return;
    }
    if (!insidePanel) {
      closeAll();
    }
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeAll();
  });
</script>

<style is:global>
  summary.nav-dd::-webkit-details-marker {
    display: none;
  }
</style>
