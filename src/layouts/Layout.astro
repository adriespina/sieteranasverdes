---
import "~/assets/styles/tailwind.css";
import "~/styles/fonts.css";

import { I18N } from "astrowind:config";

import CommonMeta from "~/components/common/CommonMeta.astro";
import Favicons from "~/components/Favicons.astro";
import CustomStyles from "~/components/CustomStyles.astro";
import ApplyColorMode from "~/components/common/ApplyColorMode.astro";
import Metadata from "~/components/common/Metadata.astro";
import SiteVerification from "~/components/common/SiteVerification.astro";
import Analytics from "~/components/common/Analytics.astro";
import BasicScripts from "~/components/common/BasicScripts.astro";

// Comment the line below to disable View Transitions
import { ClientRouter } from "astro:transitions";

import type { MetaData as MetaDataType } from "~/types";

export interface Props {
  metadata?: MetaDataType;
}

const { metadata = {} } = Astro.props;
const { textDirection } = I18N;

const fallbackTitle = "Siete Ranas Verdes · Navia";
const fallbackDesc = "Yoga, Baños de Bosque y bienestar en Navia.";
const fallbackImage = "/circuloverde.png";

type MetaSubset = {
  title?: string;
  description?: string;
  image?: string;
  canonical?: string;
  noindex?: boolean;
};
const m = metadata as MetaSubset;
// Pull values from metadata if present
const title = m?.title ?? fallbackTitle;
const description = m?.description ?? fallbackDesc;
const image = m?.image ?? fallbackImage;
const canonical = m?.canonical;
const noindex = m?.noindex ?? false;

// Compute site/url with proper fallback
const site = Astro.site ?? new URL("https://sieteranasverdes.com");
const url = new URL(Astro.url.pathname, site);
const ogImage = new URL(image, site).toString();
// JSON-LD generado dinámicamente para LocalBusiness
const ldJson = JSON.stringify(
  {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    name: "Siete Ranas Verdes",
    url: site.toString(),
    image: ogImage,
    telephone: "+34 635601842",
    email: "hola@sieteranasverdes.com",
    sameAs: ["https://www.instagram.com/siete_ranas_verdes"],
    address: {
      "@type": "PostalAddress",
      streetAddress: "Travesía del Poste, 1, Bajo",
      addressLocality: "Navia",
      addressRegion: "Asturias",
      addressCountry: "ES",
    },
    areaServed: "Navia, Asturias, España",
    keywords:
      "yoga, baños de bosque, navia, asturias, respiración, pilates, bienestar, consciencia",
  },
  null,
  2,
);
---

<!doctype html>
<html lang="es" dir={textDirection} class="scroll-smooth 2xl:text-[20px]">
  <head>
    <CommonMeta />
    <Favicons />
    <CustomStyles />
    <ApplyColorMode />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />

    <!-- Comment the line below to disable View Transitions -->
    <ClientRouter fallback="swap" />

    <!-- Preload opcional del hero por defecto de Home -->
    <link
      rel="preload"
      as="image"
      href="/img/general-yoga-1080.webp"
      imagesrcset="/img/general-yoga-480.webp 480w, /img/general-yoga-768.webp 768w, /img/general-yoga-1080.webp 1080w, /img/general-yoga-1600.webp 1600w"
      imagesizes="100vw"
      type="image/webp"
    />

    <!-- Canonical -->
    <link rel="canonical" href={canonical ?? url.toString()} />

    <!-- Robots -->
    {
      noindex ? (
        <meta name="robots" content="noindex, nofollow" />
      ) : (
        <meta name="robots" content="index, follow" />
      )
    }

    <!-- Primary Meta -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="theme-color" content="#1f7a45" />

    <!-- Keywords (informativo) -->
    <meta
      name="keywords"
      content="yoga, baños de bosque, navia, asturias, respiración, pilates, bienestar, consciencia"
    />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Siete Ranas Verdes" />
    <meta property="og:locale" content="es_ES" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={url.toString()} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content="Siete Ranas Verdes" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- JSON-LD: LocalBusiness -->
    <!-- prettier-ignore-start -->
    <script is:inline type="text/javascript">
      {
        JSON.stringify(
          {
            "@context": "https://schema.org",
            "@type": "LocalBusiness",
            name: "Siete Ranas Verdes",
            url: site.toString(),
            image: ogImage,
            telephone: "+34 635601842",
            email: "hola@sieteranasverdes.com",
            sameAs: ["https://www.instagram.com/siete_ranas_verdes"],
            address: {
              "@type": "PostalAddress",
              streetAddress: "Travesía del Poste, 1, Bajo",
              addressLocality: "Navia",
              addressRegion: "Asturias",
              addressCountry: "ES",
            },
            areaServed: "Navia, Asturias, España",
            keywords:
              "yoga, baños de bosque, navia, asturias, respiración, pilates, bienestar, consciencia",
          },
          null,
          2,
        );
      }
    </script>
    <!-- JSON-LD render dinámico para SEO -->
    <script is:inline type="application/ld+json" set:html={ldJson} />
    <!-- prettier-ignore-end -->
  </head>

  <body class="bg-page tracking-tight text-default antialiased">
    <slot />

    <BasicScripts />
  </body>
</html>
